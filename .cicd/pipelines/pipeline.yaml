apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: update-cicd
  namespace: repo-pipeline
spec:
  params:
    - name: sha
      type: string
      description: "the SHA of the recently detected change"
    - name: repoURL
      type: string
      description: "the cloneURL that the change was detected in"
  tasks:
    - name: check-for-changes
      params:
        - name: sha
          value: $(params.sha)
        - name: repoURL
          value: $(params.repoURL)
      taskRef:
        name: check-changes
    - name: yaml-updater
      params:
        - name: sha
          value: $(params.sha)
        - name: repoURL
          value: $(params.repoURL)
      taskRef:
        name: yaml-updater
      when:
        - input: $(tasks.check-for-changes.results.changed)
          operator: notin
          values: ["Changes not found"]
    - name: parse-url
      params:
        - name: repoURL
          value: $(params.repoURL)
      taskSpec:
        params:
          - name: repoURL
            type: string
            description: Git repo url
        steps:
          - name: parse-url
            image: alpine
            script: |
              #!/bin/sh
              echo -n $(params.repoURL) | sed 's/https:\/\///' > $(results.parsedURL.path)
        results:
          - name: parsedURL
            description: Returns parsed url for kamiko
    - name: update-image
      params:
        - name: repoURL
          value: $(tasks.parse-url.results.parsedURL)
      taskRef:
        name: update-image
        